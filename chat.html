<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Word App</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* チャットエリアのスタイリング */
        #messages { 
            height: 60vh; 
            overflow-y: scroll; 
            background: white; 
            border-radius: 8px;
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .message { margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        .meta { font-size: 0.8em; color: #888; margin-right: 5px; }
        
        /* 入力エリア */
        .input-group { display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        
        /* 戻るボタン */
        .back-link { display: block; margin-bottom: 20px; color: #333; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← 英単語アプリに戻る</a>
        <h2>Friend Chat</h2>
        
        <div id="messages">
            </div>

        <div class="input-group">
            <input type="text" id="msgInput" placeholder="メッセージを入力...">
            <button id="sendBtn">送信</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // 【重要】ここの設定は index.html からコピーしてくること！
        const firebaseConfig = {
        apiKey: "AIzaSyDg2EgiI-DMzmoT20zF4VJfm1MxtmhdJQQ",
        authDomain: "english-test-8ad4a.firebaseapp.com",
        projectId: "english-test-8ad4a",
        storageBucket: "english-test-8ad4a.firebasestorage.app",
        messagingSenderId: "998730699699",
        appId: "1:998730699699:web:8245c7259cec7dd20231c6",
        measurementId: "G-FC2LRFVFGF"
      };

        // 初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('msgInput');
        const btn = document.getElementById('sendBtn');

        // 送信処理
        btn.addEventListener('click', () => {
            const text = input.value;
            if (text === '') return;

            // 'chat' という新しいコレクションを作る
            db.collection("chat").add({
                text: text,
                // 誰が送ったかわかるように、とりあえず固定名を入れるか？
                // 将来的にログイン機能をつけたら user: firebase.auth().currentUser.uid に変えるんだ
                user: "自分", 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                input.value = '';
            })
            .catch((error) => console.error("Error:", error));
        });

        // 受信処理
        db.collection("chat").orderBy("timestamp").onSnapshot((snapshot) => {
            messagesDiv.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(data.text) {
                    const div = document.createElement("div");
                    div.className = "message";
                    // 時間のフォーマットは適当だが、動くことが最優先だ
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
                    div.innerHTML = `<span class="meta">${time}</span> ${data.text}`;
                    messagesDiv.appendChild(div);
                }
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    </script>
</body>
</html>
